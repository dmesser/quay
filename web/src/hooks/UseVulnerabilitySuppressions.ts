import {useMutation, useQuery} from '@tanstack/react-query';
import {AxiosError} from 'axios';
import {
  ManifestVulnerabilitySuppressionsResponse,
  getManifestVulnerabilitySuppressions,
  setManifestVulnerabilitySuppressions,
} from 'src/resources/TagResource';

export function useManifestVulnerabilitySuppressions(
  org: string,
  repo: string,
  digest: string,
  enabled: boolean,
) {
  const {
    data: suppressionsResponse,
    isInitialLoading: loadingSuppressions,
    isError: errorLoadingSuppressions,
    error: errorManifestVulnerabilitySuppressions,
  } = useQuery(
    ['manifestvulnsuppressions', org, 'repo', repo, 'digest', digest],
    () => getManifestVulnerabilitySuppressions(org, repo, digest),
    {
      enabled: enabled,
    },
  ) as {
    data: ManifestVulnerabilitySuppressionsResponse;
    isInitialLoading: boolean;
    isError: boolean;
    error: AxiosError | null;
  };

  const suppressions = suppressionsResponse?.suppressed_vulnerabilities || [];

  return {
    suppressions: suppressions,
    loadingSuppressions: loadingSuppressions,
    errorLoadingSuppressions: errorLoadingSuppressions,
    errorLoaddingSuppressionsDetails: errorManifestVulnerabilitySuppressions,
  };
}

export function useSetManifestVulnerabilitySuppressions(
  org: string,
  repo: string,
  digest: string,
) {
  const {
    mutate: mutateSettingSuppressions,
    isSuccess: successSettingSuppressions,
    isError: errorSettingSuppressions,
    error: errorSettingSuppressionsDetails,
    reset,
  } = useMutation(async ({vulnerabilities}: {vulnerabilities: string[]}) =>
    setManifestVulnerabilitySuppressions(org, repo, digest, vulnerabilities),
  ) as {
    mutate: (data: {vulnerabilities: string[]}) => void;
    isSuccess: boolean;
    isError: boolean;
    error: AxiosError | null;
    reset: () => void;
  };

  return {
    setSuppressions: mutateSettingSuppressions,
    successSettingSuppressions: successSettingSuppressions,
    errorSettingSuppressions: errorSettingSuppressions,
    errorSettingSuppressionsDetails: errorSettingSuppressionsDetails,
    resetMutation: reset,
  };
}
