import { useMutation, useQueryClient } from '@tanstack/react-query';
import { AxiosError } from 'axios';
import { RepositoryVulnerabilitySuppressionsResponse, setRepositoryVulnerabilitySuppressions } from 'src/resources/RepositoryResource';

interface UseRepositoryVulnerabilitySuppressionsOptions {
  org: string;
  repo: string;
  onSuccess?: (result: RepositoryVulnerabilitySuppressionsResponse) => void;
  onError?: (err: AxiosError) => void;
}

export function useRepositoryVulnerabilitySuppressions(options: UseRepositoryVulnerabilitySuppressionsOptions) {
  const {
    org,
    repo,
    onSuccess = () => { },
    onError = () => { },
  } = options;

  const queryClient = useQueryClient();
  const mutator = useMutation(
    async (suppressions: string[]): Promise<RepositoryVulnerabilitySuppressionsResponse> => {
      return await setRepositoryVulnerabilitySuppressions(org, repo, suppressions)
    },
    {
      onSuccess: (result: RepositoryVulnerabilitySuppressionsResponse) => {
        queryClient.invalidateQueries(['repodetails', org, repo]);
        onSuccess(result);
      },
      onError: (err: AxiosError) => {
        onError(err);
      },
    },
  );

  return {
    setSuppressions: async (suppressions: string[]) => mutator.mutate(suppressions),
    loading: mutator.isLoading,
    error: mutator.isError,
  };
}
