import {
  Alert
} from '@patternfly/react-core';
import { AxiosError } from 'axios';
import { ReactNode, useState } from 'react';
import VulnerabilitySuppressionInput from 'src/components/VulnerabilitySuppressionInput';
import { useOrganizationVulnerabilitySuppressions } from 'src/hooks/UseOrganizationVulnerabilitySuppressions';
import { addDisplayError } from 'src/resources/ErrorHandling';
import { IOrganization } from 'src/resources/OrganizationResource';

export default function OrganizationVulnerabilitySuppression(props: OrganizationVulnerabilitySuppressionProps) {
  const [alerts, setAlerts] = useState<ReactNode[]>([]);

  const {
    setSuppressions: updateVulnerabilitySuppressions,
    loading: loadingSetSuppressions,
    error: _,
  } = useOrganizationVulnerabilitySuppressions({
    org: props.organization.name,
    onSuccess: (_) => {
      setAlerts(prevAlerts => {
        return [...prevAlerts,
        <Alert key="alert" variant="success" title="Successfully updated vulnerability suppressions" isInline={true} timeout={2000} />
        ]
      });
    },
    onError: (error: AxiosError) => {
      setAlerts(prevAlerts => {
        return [...prevAlerts,
        <Alert key="alert" variant="danger" title="Error">
          {addDisplayError("Unable to update vulnerability suppressions", error)}
        </Alert>
        ]
      });
    },
  }
  );

  return (
    <VulnerabilitySuppressionInput
      suppressedVulnerabilities={props.organization.suppressed_vulnerabilities ? props.organization.suppressed_vulnerabilities : []}
      mutator={updateVulnerabilitySuppressions}
      loading={loadingSetSuppressions}
      alerts={alerts}
      setAlerts={setAlerts}
      helperText='Specify vulnerability identifiers to suppress for any image in this repository. For example "CVE-2021-44228". They will match any vulnerability identifier that contains the specified string. You can also paste space or comma separated values. Any suppression defined here will be applied to all images in in all repositories in this organization.'
    />
  );

}

interface OrganizationVulnerabilitySuppressionProps {
  organization: IOrganization;
  loading: boolean;
}
